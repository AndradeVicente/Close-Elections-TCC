---
title: "adriano 2"
output: html_document
date: "2025-09-25"
---
##Bibliotecas
```{r}
library(tidyverse)
library(haven)
library(dplyr)
library(purrr)
```

## Bases raw
```{r}
df_adriano_raw <- read_dta('../../dados/Bases/Base_cosolidada_TCC_base3.dta')
df_adriano_raw <- read_dta('../../dados/Adriano/Base_consolidada_TCC_base3.dta')

df_adriano_raw |> view()
```

```{r}
df_candidates <- readRDS('../../dados/TSE/TSE_tratado_completo.RDS')

df_candidates |> 
  filter(cd_municipio_ibge_6==110012)
```

## Robustez covariadas
```{r}
library(fastDummies)

df_rdd_cov <- df_candidates |>
  dummy_cols(
    select_columns = c("cov_candidato_partido",
                       "cov_candidato_educacao_agrupada"),
    remove_selected_columns = FALSE
  )

#Teste- deu certo
df_rdd_cov |> 
  filter(cd_municipio_ibge_6==110012)

##rdd com covariadas:
y_vars <- names(df_rdd_cov)[
  grepl("^cov_", names(df_rdd_cov)) &
    !names(df_rdd_cov) %in% c(
      "cov_candidato_partido",
      "cov_candidato_educacao_agrupada"
    )
]

map(y_vars, ~ RDD(
  df_rdd_cov,
  x = val_margem_vitoria_feminina,
  y = !!sym(.x)
))

```
#Sinan com as covariadas
```{r}

##rdd com covariadas:
y_vars <- names(df_rdd_sinan_cov)[
  grepl("^cov_", names(df_rdd_sinan_cov)) &
    !names(df_rdd_sinan_cov) %in% c(
      "cov_candidato_partido",
      "cov_candidato_educacao_agrupada"
    )
]

map(y_vars, ~ RDD(
  df_rdd_sinan_cov,
  x = val_margem_vitoria_feminina,
  y = !!sym(.x)
))
```
## Função RDD principal
```{r}
RDD <- function(df, x, y) {

  library(rdrobust)
  
    # pega o nome da variável y em formato string
  y_name <- as_label(enquo(y))
  cat("\n====================\n")
  cat("Resultado para variável:", y_name, "\n")

  df <- df |>
    filter(
      !is.na({{x}}),
      !is.na({{y}}),
      !is.na(ano),
      !is.na(cov_reeleicao),
      !is.na(cov_candidato_partido),
      !is.na(cov_candidato_patrimonio),
      !is.na(cov_candidato_despesa_campanha_rs),
      !is.na(cov_candidato_educacao_agrupada),
      !is.na(cov_candidato_idade),
      !is.na(cov_municipio_proporcao_mulheres_pop),
      !is.na(cov_municipio_pop_total),
      # !is.na(cov_pib_pc),
      !is.na(cd_municipio_ibge_7)
    )

  num_eventos <- df |> summarise(total = sum({{y}}, na.rm = TRUE)) |> pull(total)

  if (num_eventos < 50) {
    message(glue::glue("Só {num_eventos} eventos. Pulando variável."))
    return(NULL)
  }
  
  
  controls <- model.matrix(
    ~ ano 
    + cov_reeleicao 
    + cov_candidato_partido 
    + cov_candidato_patrimonio
    + cov_candidato_despesa_campanha_rs
    + cov_candidato_educacao_agrupada 
    + cov_candidato_idade
    + cov_municipio_proporcao_mulheres_pop
    + cov_municipio_pop_total 
    #+ cov_pib_pc
    , data = df)

  x_vals <- df |> pull({{x}})
  y_vals <- df |> pull({{y}})

  regressao <- rdrobust(
    x = x_vals,
    y = y_vals,
    covs = controls,
    cluster = df$cd_municipio_ibge_7,
    all = TRUE,
    kernel = "triangular"
  )

  print(summary(regressao))

  h <- regressao$bws[1]

  dados_filtrados <- tibble(x = x_vals, y = y_vals) |>
    filter(abs(x) <= h)

  ymax <- mean(dados_filtrados$y)

  rdplot(
    y = y_vals,
    x = x_vals,
    kernel = "triangular",
    x.lim = c(-h, h),
    y.lim = c(0, ymax * 2),
    title = paste("RDD Plot -", y_name),
    nbins = 100,
    p = 4
  )
}
```

## Função teste de robustez
```{r}

library(tidyverse)
library(rdrobust)
library(rlang)
library(glue)
library(patchwork)



RDD_sensibilidade <- function(df, x, y) {

  x <- enquo(x)
  y <- enquo(y)
  y_name <- as_label(y)

  cat("\n====================\n")
  cat("Variável dependente:", y_name, "\n")

  df <- df |>
    filter(!is.na(!!x), !is.na(!!y), !is.na(ano), !is.na(cd_municipio_ibge_7))

  num_eventos <- df |> summarise(total = sum(!!y, na.rm = TRUE)) |> pull()
  if (num_eventos < 50) {
    message(glue("Só {num_eventos} eventos. Pulando variável: {y_name}"))
    return(NULL)
  }

  controls <- model.matrix(~ ano, data = df)

  x_vals <- df |> pull(!!x)
  y_vals <- df |> pull(!!y)

  # Roda com bandwidth ótimo
  rd_opt <- rdrobust(
    x = x_vals,
    y = y_vals,
    covs = controls,
    cluster = df$cd_municipio_ibge_7,
    all = TRUE,
    kernel = "triangular"
  )
  print(summary(rd_opt))

  # Sensibilidade
  bandwidths <- seq(0.05, 1, by = 0.1)
  betas <- numeric(length(bandwidths))
  pvalues <- numeric(length(bandwidths))

  for (i in seq_along(bandwidths)) {
    res <- rdrobust(
      x = x_vals, y = y_vals,
      covs = controls,
      cluster = df$cd_municipio_ibge_7,
      h = bandwidths[i],
      all = TRUE,
      kernel = "triangular"
    )
    betas[i] <- res$coef[1]
    pvalues[i] <- res$pv[1]
  }

  results <- tibble(
    bandwidth = bandwidths,
    beta = betas,
    pvalue = pvalues
  )

  g1 <- results |>
    ggplot(aes(bandwidth, beta)) +
    geom_line() + geom_point() +
    labs(title = paste("Coef vs bandwidth -", y_name), y = "coef.")

  g2 <- results |>
    ggplot(aes(bandwidth, pvalue)) +
    geom_line() + geom_point() +
    labs(title = paste("p-value vs bandwidth -", y_name), y = "p-value")

  g1 / g2
}
```

## Sinan
base sinan filtrando para casos de mulheres
```{r}

consolidado_sinan_fem <- df_adriano_raw |> 

  select(
    
    cd_muni = ibge,
    year,

    # y_sinan_viol_fisica = VIOL_FISIC_fem,
    # y_sinan_viol_financeira = VIOL_FINAN_fem,
    y_sinan_viol_psicologica = VIOL_PSICO_fem,
    # y_sinan_viol_tortura = VIOL_TORT_fem,
    # y_sinan_viol_sexual = VIOL_SEXU_fem,
    # y_sinan_viol_trafico_humano = VIOL_TRAF_fem,
    # y_sinan_viol_negligencia = VIOL_NEGLI_fem,
    # y_sinan_viol_trabalho_infantil = VIOL_INFAN_fem,
    # y_sinan_viol_intervencao_legal = VIOL_LEGAL_fem,
    # y_sinan_viol_outros = VIOL_OUTR_fem,
    # 
    # y_sinan_agressao_forca = AG_FORCA_fem,
    # y_sinan_agressao_enforcamento = AG_ENFOR_fem,
    y_sinan_agressao_objeto_contudente = AG_OBJETO_fem,
    # y_sinan_agressao_corte = AG_CORTE_fem,
    # y_sinan_agressao_quente = AG_QUENTE_fem,
    # y_sinan_agressao_evenenamento = AG_ENVEN_fem,
    # y_sinan_agressao_fogo = AG_FOGO_fem,
    y_sinan_agressao_ameaca = AG_AMEACA_fem) |> 
    # y_sinan_agressao_outros = AG_OUTROS_fem,
    # 
    # y_sinan_sex_assedio = SEX_ASSEDI_fem,
    # y_sinan_sex_estupro = SEX_ESTUPR_fem,
    # y_sinan_sex_pudor = SEX_PUDOR_fem,
    # y_sinan_sex_pornografia_infantil = SEX_PORNO_fem,
    # y_sinan_sex_exploracao_sexual = SEX_EXPLO_fem,
    # y_sinan_sex_outro = SEX_OUTRO_fem) |> 
  
  mutate(
    mandato = case_when(year %% 4 == 0 ~ year - 4,
                        year %% 4 == 1 ~ year - 1,
                        year %% 4 == 2 ~ year - 2,
                        year %% 4 == 3 ~ year - 3),
    cd_muni = as.character(cd_muni)) |> 
  group_by(cd_muni, mandato) |> 
  
  summarise(across(
    .cols = starts_with("y_"),       
    .fns = ~ sum(.),  
    .names = "{.col}")) |> 
  
  mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))



```

base sinan geral 

```{r}

consolidado_sinan <- df_adriano_raw |> 
  select(
    ibge, year,

    total, afastamento_trabalho, afastamento_situacao,
    habitos_psicofarmacos, habitos_fumar, habitos_drogas, habitos_alcool,
    encaminhamento_caps, cura, cura_nao_conf, sexo_F, sexo_M,
    obito_trabalho, incapacidade_temp, incapacidade_perm_par, incapacidade_perm_tot,

    OUT_VEZES_masc, OUT_VEZES_fem,
    LES_AUTOP_masc, LES_AUTOP_fem,
    VIOL_FISIC_masc, VIOL_FISIC_fem,
    VIOL_FINAN_masc, VIOL_FINAN_fem,
    VIOL_PSICO_masc, VIOL_PSICO_fem,
    VIOL_TORT_masc, VIOL_TORT_fem,
    VIOL_SEXU_masc, VIOL_SEXU_fem,
    VIOL_TRAF_masc, VIOL_TRAF_fem,
    VIOL_NEGLI_masc, VIOL_NEGLI_fem,
    VIOL_INFAN_masc, VIOL_INFAN_fem,
    VIOL_LEGAL_masc, VIOL_LEGAL_fem,
    VIOL_OUTR_masc, VIOL_OUTR_fem,

    AG_FORCA_masc, AG_FORCA_fem,
    AG_ENFOR_masc, AG_ENFOR_fem,
    AG_OBJETO_masc, AG_OBJETO_fem,
    AG_CORTE_masc, AG_CORTE_fem,
    AG_QUENTE_masc, AG_QUENTE_fem,
    AG_ENVEN_masc, AG_ENVEN_fem,
    AG_FOGO_masc, AG_FOGO_fem,
    AG_AMEACA_masc, AG_AMEACA_fem,
    AG_OUTROS_masc, AG_OUTROS_fem,

    SEX_ASSEDI_masc, SEX_ASSEDI_fem,
    SEX_ESTUPR_masc, SEX_ESTUPR_fem,
    SEX_PUDOR_masc, SEX_PUDOR_fem,
    SEX_PORNO_masc, SEX_PORNO_fem,
    SEX_EXPLO_masc, SEX_EXPLO_fem,
    SEX_OUTRO_masc, SEX_OUTRO_fem,

    PROC_ABORT_masc, PROC_ABORT_fem,
    PROC_SEMEN_masc, PROC_SEMEN_fem,
    PROC_VAGIN_masc, PROC_VAGIN_fem,
    PROC_CONTR_masc, PROC_CONTR_fem,

    CONS_DST_masc, CONS_DST_fem,
    CONS_SUIC_masc, CONS_SUIC_fem,
    CONS_MENT_masc, CONS_MENT_fem,
    CONS_ESTRE_masc, CONS_ESTRE_fem,

    ENC_SAUDE_masc, ENC_SAUDE_fem,
    ENC_ABRIGO_masc, ENC_ABRIGO_fem,
    ENC_SENTIN_masc, ENC_SENTIN_fem,
    ENC_DEAM_masc, ENC_DEAM_fem,
    ENC_DPCA_masc, ENC_DPCA_fem,
    ENC_DELEG_masc, ENC_DELEG_fem,
    ENC_MPU_masc, ENC_MPU_fem,
    ENC_MULHER_masc, ENC_MULHER_fem,
    ENC_CREAS_masc, ENC_CREAS_fem,
    ENC_IML_masc, ENC_IML_fem
  ) |> 

  mutate(
    cd_muni = ibge,

    # sinan mental
    # y_sinan_mental_total_ocor_trab = total,
    # y_sinan_mental_afast_trab = afastamento_trabalho,
    # y_sinan_mental_afast_trab_desgaste = afastamento_situacao,
    # y_sinan_mental_hab_psicofarmacos = habitos_psicofarmacos,
    # y_sinan_mental_hab_fumar = habitos_fumar,
    # y_sinan_mental_hab_drogas = habitos_drogas,
    # y_sinan_mental_hab_alcool = habitos_alcool,
    # y_sinan_mental_encaminhamento_caps = encaminhamento_caps,
    # y_sinan_mental_cura = cura,
    # y_sinan_mental_cura_n_conf = cura_nao_conf,
    # y_sinan_mental_trabalho_obs_F = sexo_F,
    # y_sinan_mental_trabalho_obs_M = sexo_M,
    # y_sinan_mental_trabalho_obito = obito_trabalho,
    # y_sinan_mental_incapacidade_temp = incapacidade_temp,
    # y_sinan_mental_incapacidade_parc = incapacidade_perm_par,
    # y_sinan_mental_incapacidade_total = incapacidade_perm_tot,

    # sinan violência
    # y_sinan_reincidencia = OUT_VEZES_masc + OUT_VEZES_fem,
    # y_sinan_autoprovocada = LES_AUTOP_masc + LES_AUTOP_fem,
    # y_sinan_viol_fisica = VIOL_FISIC_masc + VIOL_FISIC_fem,
    # y_sinan_viol_financeira = VIOL_FINAN_masc + VIOL_FINAN_fem,
    y_sinan_viol_psicologica = VIOL_PSICO_masc + VIOL_PSICO_fem,
    # y_sinan_viol_tortura = VIOL_TORT_masc + VIOL_TORT_fem,
    # y_sinan_viol_sexual = VIOL_SEXU_masc + VIOL_SEXU_fem,
    # y_sinan_viol_trafico_humano = VIOL_TRAF_masc + VIOL_TRAF_fem,
    # y_sinan_viol_negligencia = VIOL_NEGLI_masc + VIOL_NEGLI_fem,
    # y_sinan_viol_trabalho_infantil = VIOL_INFAN_masc + VIOL_INFAN_fem,
    # y_sinan_viol_intervencao_legal = VIOL_LEGAL_masc + VIOL_LEGAL_fem,
    # y_sinan_viol_outros = VIOL_OUTR_masc + VIOL_OUTR_fem,

    # sinan meio de agressão
    # y_sinan_agressao_forca = AG_FORCA_masc + AG_FORCA_fem,
    # y_sinan_agressao_enforcamento = AG_ENFOR_masc + AG_ENFOR_fem,
    y_sinan_agressao_objeto_contudente = AG_OBJETO_masc + AG_OBJETO_fem,
    # y_sinan_agressao_corte = AG_CORTE_masc + AG_CORTE_fem,
    # y_sinan_agressao_quente = AG_QUENTE_masc + AG_QUENTE_fem,
    # y_sinan_agressao_evenenamento = AG_ENVEN_masc + AG_ENVEN_fem,
    # y_sinan_agressao_fogo = AG_FOGO_masc + AG_FOGO_fem,
    y_sinan_agressao_ameaca = AG_AMEACA_masc + AG_AMEACA_fem,
    # y_sinan_agressao_outros = AG_OUTROS_masc + AG_OUTROS_fem,

    # sinan violência sexual
    # y_sinan_sex_assedio = SEX_ASSEDI_masc + SEX_ASSEDI_fem,
    # y_sinan_sex_estupro = SEX_ESTUPR_masc + SEX_ESTUPR_fem,
    # y_sinan_sex_pudor = SEX_PUDOR_masc + SEX_PUDOR_fem,
    # y_sinan_sex_pornografia_infantil = SEX_PORNO_masc + SEX_PORNO_fem,
    # y_sinan_sex_exploracao_sexual = SEX_EXPLO_masc + SEX_EXPLO_fem,
    # y_sinan_sex_outro = SEX_OUTRO_masc + SEX_OUTRO_fem,
    # 
    # # sinan procedimento
    # y_sinan_procedimento_aborto = PROC_ABORT_masc + PROC_ABORT_fem,
    # y_sinan_procedimento_coleta_semen = PROC_SEMEN_masc + PROC_SEMEN_fem,
    # y_sinan_procedimento_coleta_vaginal = PROC_VAGIN_masc + PROC_VAGIN_fem,
    # y_sinan_procedimento_contracepcao_emerg = PROC_CONTR_masc + PROC_CONTR_fem,

    # notificações
    # y_sinan_notificacao_dst = CONS_DST_masc + CONS_DST_fem,
    # y_sinan_notificacao_suicidio = CONS_SUIC_masc + CONS_SUIC_fem,
    y_sinan_notificacao_mental = CONS_MENT_masc + CONS_MENT_fem,
    # y_sinan_notificacao_estresse_pos_tra = CONS_ESTRE_masc + CONS_ESTRE_fem,
    # 
    # # encaminhamentos
    # y_sinan_enc_rede_saude = ENC_SAUDE_masc + ENC_SAUDE_fem,
    y_sinan_enc_abrigo = ENC_ABRIGO_masc + ENC_ABRIGO_fem,
    # y_sinan_enc_sentinela = ENC_SENTIN_masc + ENC_SENTIN_fem,
    y_sinan_enc_deam = ENC_DEAM_masc + ENC_DEAM_fem,
    # y_sinan_enc_dpca = ENC_DPCA_masc + ENC_DPCA_fem,
    # y_sinan_enc_delegacia_outra = ENC_DELEG_masc + ENC_DELEG_fem,
    # y_sinan_enc_mp = ENC_MPU_masc + ENC_MPU_fem,
    # y_sinan_enc_mulher_abrigo = ENC_MULHER_masc + ENC_MULHER_fem,
    # y_sinan_enc_creas = ENC_CREAS_masc + ENC_CREAS_fem,
    # y_sinan_enc_iml = ENC_IML_masc + ENC_IML_fem
  ) |> 

  mutate(
    mandato = case_when(
      year %% 4 == 0 ~ year - 4,
      year %% 4 == 1 ~ year - 1,
      year %% 4 == 2 ~ year - 2,
      year %% 4 == 3 ~ year - 3
    ),
    cd_muni = as.character(cd_muni)
  ) |> 
  group_by(cd_muni, mandato) |> 
  summarise(across( .cols = starts_with("y_"), .fns = ~ sum(.), .names = "{.col}")) |> mutate(across( .cols = starts_with("y_"), .fns = ~ replace_na(., 0), .names = "{.col}"))

```

```{r}
df_rdd_sinan <- df_candidates |>
  left_join(consolidado_sinan_fem, by = c("ano" = "mandato", "cd_municipio_ibge_6" = "cd_muni")) |> 

  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ (. / cov_municipio_pop_total) * 100000)) |> 

  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ replace_na(., 0))) |> 
  
  filter(!ano %in% c("2004")) |> 
  

  # cria y_previous por município + ano ordenado
  arrange(cd_municipio_ibge_6, ano) |>
  group_by(cd_municipio_ibge_6) |>
  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ lag(.),
    .names = "{.col}_previous")) |>
  
  ungroup()

df_rdd_sinan |> 
  filter(cd_municipio_ibge_6==110004)

```



RDD sinan
```{r}

y_vars <- names(df_rdd_sinan)[grepl("^y_", names(df_rdd_sinan))]
map(y_vars, ~ {RDD(df_rdd_sinan, x = val_margem_vitoria_feminina, y = !!sym(.x))})


#####rdd 2020
#map(y_vars, ~ {Rdd20(df_rdd_sinan, x = val_margem_vitoria_feminina, y = !!sym(.x))})

```

## Teste de sensibilidade Sinan

```{r}
y_vars <- names(df_rdd_sinan)[grepl("^y_", names(df_rdd_sinan))]

map(
  y_vars,
  ~ RDD_sensibilidade(
      df = df_rdd_sinan,
      x = val_margem_vitoria_feminina,
      y = !!sym(.x)
    )
)

```



```{r}

RDD(df_rdd_sinan, x = val_margem_vitoria_feminina, y = y_sinan_viol_psicologica)

rdplot(
  y = df_rdd_sinan$y_sinan_viol_psicologica,
  x = df_rdd_sinan$val_margem_vitoria_feminina,
  kernel = "triangular",
  x.lim = c(-0.141, 0.141),
  # y.lim = c(30, 100),
  nbins = 100,
  p = 4)

```

## SIA - Duda
descrição e label variáveis
```{r}

get_label <- function(x) {
  lb <- attr(x, "label", exact = TRUE)
  if (is.null(lb)) NA_character_ else as.character(lb)
}

proc_df <- df_adriano_raw %>% select(matches("^proc_\\d{2}$"))

descricoes <- tibble(
  variavel  = names(proc_df),
  descricao = map_chr(proc_df, get_label)
)

descricoes


```

ab: atenção básica; cap: centro de atenção psicossocial

```{r}

consolidado_sia <- df_adriano_raw |> 

  select(
    
    cd_muni = ibge,
    year,

    y_sia_serv_resid_terap = proc_01,
    y_sia_serv_resid_terap_transit = proc_02,
    y_sia_equipes_pessoa_prob_droga = proc_03,
    y_sia_pratica_corp_cap = proc_04,
    y_sia_matric_eq_ab = proc_05,
    y_sia_atend_indiv_cap = proc_06,
    y_sia_atend_gp_cap = proc_07,
    y_sia_atend_familia_cap = proc_08,
    y_sia_atend_inic_cap = proc_09,
    y_sia_atend_dom_pac_cap = proc_10,
    y_sia_abord_cog_fumante = proc_11,
    y_sia_acomp_pac_saude_mental = proc_12,
    y_sia_atend_oficina_terap1 = proc_13,
    y_sia_atend_oficina_terap2 = proc_14,
    y_sia_atend_psico_gp = proc_15,
    y_sia_atend_psico_indiv = proc_16,
    y_sia_acomp_adulto_sofre_drogas = proc_17,
    y_sia_acomp_jovem_sofre_drogas = proc_18,
    y_sia_acomp_neuropsi_paciente_reab = proc_20,
    y_sia_atend_urg_atencao_especializada = proc_21)|> 
  
  mutate(
    mandato = case_when(year %% 4 == 0 ~ year - 4,
                        year %% 4 == 1 ~ year - 1,
                        year %% 4 == 2 ~ year - 2,
                        year %% 4 == 3 ~ year - 3),
    cd_muni = as.character(cd_muni),
    y_sia_servi_resid_terap= y_sia_serv_resid_terap+y_sia_serv_resid_terap_transit,
    y_sia_atend_cap=y_sia_atend_indiv_cap+y_sia_atend_gp_cap+y_sia_atend_familia_cap+y_sia_atend_inic_cap+y_sia_atend_dom_pac_cap+y_sia_acomp_pac_saude_mental+y_sia_atend_psico_gp+y_sia_atend_psico_indiv,
    y_sia_atend_oficina= y_sia_atend_oficina_terap1+y_sia_atend_oficina_terap2,
    y_sia_acomp_drogas=y_sia_acomp_adulto_sofre_drogas+y_sia_acomp_jovem_sofre_drogas) |> 
  group_by(cd_muni, mandato) |> 
  
  summarise(across(
    .cols = starts_with("y_"),       
    .fns = ~ sum(.),  
    .names = "{.col}")) |> 
  
  mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))



```


```{r}

df_rdd_sia <- df_candidates |>
  filter(!ano %in% c('2004')) |> 
  #filter(ano==2020) |>
  left_join(consolidado_sia, by = c('ano' = 'mandato', 'cd_municipio_ibge_6' = 'cd_muni')) |> 
  
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ (./cov_municipio_pop_total)*100000,
    .names = "{.col}")) |> 
    
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))

```

```{r}

y_vars <- names(df_rdd_sia)[grepl("^y_", names(df_rdd_sia))]

map(y_vars, ~ {RDD(df_rdd_sia, x = val_margem_vitoria_feminina, y = !!sym(.x))})

#####rdd 2020
#map(y_vars, ~ {Rdd20(df_rdd_sia, x = val_margem_vitoria_feminina, y = !!sym(.x))})

```
```{r}

RDD(df_rdd_sia, x = val_margem_vitoria_feminina, y = y_sia_atend_oficina_terap2)

rdplot(
  y = df_rdd_sia$y_sia_atend_oficina_terap2,
  x = df_rdd_sia$val_margem_vitoria_feminina,
  kernel = "triangular",
  x.lim = c(-0.141, 0.141),
  y.lim = c(-500, 500),
  nbins = 100,
  p = 4)

```


## SIH - Duda
descrição e label variáveis
```{r}


get_label <- function(x) {
  lb <- attr(x, "label", exact = TRUE)
  if (is.null(lb)) NA_character_ else as.character(lb)
}

# Seleciona todas as colunas que começam com F (maiúsculo)
f_df <- df_adriano_raw %>% 
  select(matches("^F"))

# Extrai nomes e labels
descricoes_F <- tibble(
  variavel  = names(f_df),
  descricao = map_chr(f_df, get_label)
)

descricoes_F

```

Curta: hospitalização de curta duração/ Longa; longa duração.
```{r}
consolidado_sih <- df_adriano_raw |> 
  select(
    cd_muni = ibge,
    year,
    ## homem
    # y_sih_desordem_mental_curta_masc = F00_F09_curta_masc,
    # y_sih_desordem_mental_por_drogas_curta_masc = F10_F19_curta_masc,
    y_sih_desordem_humor_curta_masc = F30_F39_curta_masc,
    # y_sih_desordem_mental_por_estresse_curta_masc = F40_F49_curta_masc,
    # y_sih_desordem_mental_esquizofrenia_curta_masc = F20_F29_curta_masc,
    # y_sih_sindromes_comportamentais_curta_masc = F50_F59_curta_masc,
    # y_sih_desordem_mental_personalidade_masc = F60_F69_curta_masc,
    y_sih_retardo_mental_curta_masc = F70_F79_curta_masc,
    # y_sih_desordem_mental_infancia_adolesc_curta_masc = F90_F99_curta_masc,
    # y_sih_desordem_mental_comportamento_curta_masc = F00_F99_curta_masc,
    # y_sih_desordem_mental_long_masc = F00_F09_longa_masc,
    # y_sih_desordem_mental_por_drogas_long_masc = F10_F19_longa_masc,
    # y_sih_desordem_humor_long_masc = F30_F39_longa_masc,
    # y_sih_desordem_mental_por_estresse_long_masc = F40_F49_longa_masc,
    # y_sih_desordem_mental_esquizofrenia_long_masc = F20_F29_longa_masc,
    # y_sih_sindromes_comportamentais_long_masc = F50_F59_longa_masc,
    # y_sih_desordem_mental_personalidade_long_masc = F60_F69_longa_masc,
    y_sih_retardo_mental_long_masc = F70_F79_longa_masc,
    # y_sih_desordem_mental_infancia_adolesc_long_masc = F90_F99_longa_masc,
    # y_sih_desordem_mental_comportamento_long_masc = F00_F99_longa_masc,
    ## mulher
    # y_sih_desordem_mental_curta_fem = F00_F09_curta_fem,
    # y_sih_desordem_mental_por_drogas_curta_fem = F10_F19_curta_fem,
    y_sih_desordem_humor_curta_fem = F30_F39_curta_fem,
    # y_sih_desordem_mental_por_estresse_curta_fem = F40_F49_curta_fem,
    # y_sih_desordem_mental_esquizofrenia_curta_fem = F20_F29_curta_fem,
    # y_sih_sindromes_comportamentais_curta_fem = F50_F59_curta_fem,
    # y_sih_desordem_mental_personalidade_curta_fem = F60_F69_curta_fem,
    # y_sih_retardo_mental_curta_fem = F70_F79_curta_fem,
    # y_sih_desordem_mental_infancia_adolesc_curta_fem = F90_F99_curta_fem,
    # y_sih_desordem_mental_comportamento_curta_fem = F00_F99_curta_fem,
    # y_sih_desordem_mental_long_fem = F00_F09_longa_fem,
    # y_sih_desordem_mental_por_drogas_long_fem = F10_F19_longa_fem,
    # y_sih_desordem_humor_long_fem = F30_F39_longa_fem,
    # y_sih_desordem_mental_por_estresse_long_fem = F40_F49_longa_fem,
    # y_sih_desordem_mental_esquizofrenia_long_fem = F20_F29_longa_fem,
    # y_sih_sindromes_comportamentais_long_fem = F50_F59_longa_fem,
    # y_sih_desordem_mental_personalidade_long_fem = F60_F69_longa_fem,
    # y_sih_retardo_mental_long_fem = F70_F79_longa_fem,
    # y_sih_desordem_mental_infancia_adolesc_long_fem = F90_F99_longa_fem,
    # y_sih_desordem_mental_comportamento_long_fem = F00_F99_longa_fem
  ) |> 
  mutate(
    mandato = case_when(
      year %% 4 == 0 ~ year - 4,
      year %% 4 == 1 ~ year - 1,
      year %% 4 == 2 ~ year - 2,
      year %% 4 == 3 ~ year - 3
    ),
    cd_muni = as.character(cd_muni),

    ## mulheres
    # y_sih_hosp_desordem_mental_curta_fem =
      # y_sih_desordem_mental_curta_fem +
      # y_sih_desordem_mental_por_drogas_curta_fem +
      # y_sih_desordem_humor_curta_fem +
      # y_sih_desordem_mental_por_estresse_curta_fem +
      # y_sih_desordem_mental_esquizofrenia_curta_fem +
      # y_sih_sindromes_comportamentais_curta_fem +
      # y_sih_desordem_mental_personalidade_curta_fem +
      # y_sih_retardo_mental_curta_fem +
      # y_sih_desordem_mental_infancia_adolesc_curta_fem +
      # y_sih_desordem_mental_comportamento_curta_fem,

    # y_sih_hosp_desordem_mental_longa_fem =
      # y_sih_desordem_mental_long_fem +
      # y_sih_desordem_mental_por_drogas_long_fem +
      # y_sih_desordem_humor_long_fem +
      # y_sih_desordem_mental_por_estresse_long_fem +
      # y_sih_desordem_mental_esquizofrenia_long_fem +
      # y_sih_sindromes_comportamentais_long_fem +
      # y_sih_desordem_mental_personalidade_long_fem +
      # y_sih_retardo_mental_long_fem +
      # y_sih_desordem_mental_infancia_adolesc_long_fem +
      # y_sih_desordem_mental_comportamento_long_fem,

    ## totais (homens + mulheres)
    # y_sih_desordem_mental_curta = y_sih_desordem_mental_curta_masc + y_sih_desordem_mental_curta_fem,
    # y_sih_desordem_mental_por_drogas_curta = y_sih_desordem_mental_por_drogas_curta_masc + y_sih_desordem_mental_por_drogas_curta_fem,
    y_sih_desordem_humor_curta = y_sih_desordem_humor_curta_masc + y_sih_desordem_humor_curta_fem,
    # y_sih_desordem_mental_por_estresse_curta = y_sih_desordem_mental_por_estresse_curta_masc + y_sih_desordem_mental_por_estresse_curta_fem,
    # y_sih_desordem_mental_esquizofrenia_curta = y_sih_desordem_mental_esquizofrenia_curta_masc + y_sih_desordem_mental_esquizofrenia_curta_fem,
    # y_sih_sindromes_comportamentais_curta = y_sih_sindromes_comportamentais_curta_masc + y_sih_sindromes_comportamentais_curta_fem,
    # y_sih_desordem_mental_personalidade_curta = y_sih_desordem_mental_personalidade_masc + y_sih_desordem_mental_personalidade_curta_fem,
    # y_sih_retardo_mental_curta = y_sih_retardo_mental_curta_masc + y_sih_retardo_mental_curta_fem,
    # y_sih_desordem_mental_infancia_adolesc_curta = y_sih_desordem_mental_infancia_adolesc_curta_masc + y_sih_desordem_mental_infancia_adolesc_curta_fem,
    # y_sih_desordem_mental_comportamento_curta = y_sih_desordem_mental_comportamento_curta_masc + y_sih_desordem_mental_comportamento_curta_fem,

    # y_sih_desordem_mental_long = y_sih_desordem_mental_long_masc + y_sih_desordem_mental_long_fem,
    # y_sih_desordem_mental_por_drogas_long = y_sih_desordem_mental_por_drogas_long_masc + y_sih_desordem_mental_por_drogas_long_fem,
    # y_sih_desordem_humor_long = y_sih_desordem_humor_long_masc + y_sih_desordem_humor_long_fem,
    # y_sih_desordem_mental_por_estresse_long = y_sih_desordem_mental_por_estresse_long_masc + y_sih_desordem_mental_por_estresse_long_fem,
    # y_sih_desordem_mental_esquizofrenia_long = y_sih_desordem_mental_esquizofrenia_long_masc + y_sih_desordem_mental_esquizofrenia_long_fem,
    # y_sih_sindromes_comportamentais_long = y_sih_sindromes_comportamentais_long_masc + y_sih_sindromes_comportamentais_long_fem,
    # y_sih_desordem_mental_personalidade_long = y_sih_desordem_mental_personalidade_long_masc + y_sih_desordem_mental_personalidade_long_fem,
    # y_sih_retardo_mental_long = y_sih_retardo_mental_long_masc + y_sih_retardo_mental_long_fem,
    # y_sih_desordem_mental_infancia_adolesc_long = y_sih_desordem_mental_infancia_adolesc_long_masc + y_sih_desordem_mental_infancia_adolesc_long_fem,
    # y_sih_desordem_mental_comportamento_long = y_sih_desordem_mental_comportamento_long_masc + y_sih_desordem_mental_comportamento_long_fem,

    ## totais gerais
    # y_sih_hosp_desordem_mental_curta = 
      # y_sih_desordem_mental_curta + y_sih_desordem_mental_por_drogas_curta + y_sih_desordem_humor_curta +
      # y_sih_desordem_mental_por_estresse_curta + y_sih_desordem_mental_esquizofrenia_curta + y_sih_sindromes_comportamentais_curta +
      # y_sih_desordem_mental_personalidade_curta + y_sih_retardo_mental_curta +
      # y_sih_desordem_mental_infancia_adolesc_curta + y_sih_desordem_mental_comportamento_curta,

    # y_sih_hosp_desordem_mental_longa =
      # y_sih_desordem_mental_long + y_sih_desordem_mental_por_drogas_long + y_sih_desordem_humor_long +
      # y_sih_desordem_mental_por_estresse_long + y_sih_desordem_mental_esquizofrenia_long + y_sih_sindromes_comportamentais_long +
      # y_sih_desordem_mental_personalidade_long + y_sih_retardo_mental_long +
      # y_sih_desordem_mental_infancia_adolesc_long + y_sih_desordem_mental_comportamento_long
  ) |> 
  group_by(cd_muni, mandato) |> 
  summarise(across(starts_with("y_"), sum, na.rm = TRUE)) |> 
  mutate(across(starts_with("y_"), ~ replace_na(., 0)))


```


```{r}

df_rdd_sih <- df_candidates |>
  filter(!ano %in% c("2004")) |> 
  left_join(
    consolidado_sih,
    by = c("ano" = "mandato", "cd_municipio_ibge_6" = "cd_muni")
  ) |> 

  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ (. / cov_municipio_pop_total) * 100000
  )) |> 

  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ replace_na(., 0)
  )) |> 

  group_by(cd_municipio_ibge_6) |>
  arrange(ano, .by_group = TRUE) |>
  mutate(across(
    .cols  = starts_with("y_"),
    .fns   = ~ lag(.),
    .names = "{.col}_previous"
  )) |>
  ungroup()

```

```{r}

y_vars <- names(df_rdd_sih)[grepl("^y_", names(df_rdd_sih))]

map(y_vars, ~ {RDD(df_rdd_sih, x = val_margem_vitoria_feminina, y = !!sym(.x))})

#####rdd 2020
#map(y_vars, ~ {Rdd20(df_rdd_sih, x = val_margem_vitoria_feminina, y = !!sym(.x))})

```

```{r}

RDD(df_rdd_sih, x = val_margem_vitoria_feminina, y = y_sih_desordem_humor_curta)

rdplot(
  y = df_rdd_sih$y_sih_desordem_humor_curta,
  x = df_rdd_sih$val_margem_vitoria_feminina,
  kernel = "triangular",
  x.lim = c(-0.137, 0.137),
  y.lim = c(55, 130),
  nbins = 100,
  p = 1)
```


## Teste de sensibilidade Sih

```{r}
y_vars <- names(df_rdd_sih)[grepl("^y_", names(df_rdd_sih))]

map(
  y_vars,
  ~ RDD_sensibilidade(
      df = df_rdd_sih,
      x = val_margem_vitoria_feminina,
      y = !!sym(.x)
    )
)

```
# CBO

verificar varíaveis e labels
```{r}

vars_cbo <- names(df_adriano_raw)[grepl("^cbo", names(df_adriano_raw), ignore.case = TRUE)]

tibble(
  variavel   = vars_cbo,
  descricao  = sapply(vars_cbo, function(v) attr(df_adriano_raw[[v]], "label"))
)


```


criar a base com variáveis CBO em variação (ab = atenção básica)
```{r}
consolidado_cbo <- df_adriano_raw |> 
  select(
    cd_muni_ibge = ibge,
    year,
    # y_cbo_medico_diag_terap       = CBO_2253,
    # y_cbo_ass_social              = CBO_2216_05,
    # y_cbo_psico_clinico           = CBO_2215_10,
    y_cbo_psico_e_psicanalista    = CBO_2515,
    y_cbo_psiquiatra              = CBO_2251_33,
    # y_cbo_terapeuta_ocupac        = CBO_2239_05,
    # y_cbo_medico_diag_terap_ab    = CBO_2253_atbas,
    # y_cbo_psico_clinico_ab        = CBO_2215_10_atbas,
    # y_cbo_ass_social_ab           = CBO_2216_05_atbas,
    # y_cbo_psico_e_psicanalista_ab = CBO_2515_atbas,
    y_cbo_psiquiatra_ab           = CBO_2251_33_atbas,
    # y_cbo_terapeuta_ocupac_ab     = CBO_2239_05_atbas
  ) |> 
  mutate(
    mandato = case_when(
      year %% 4 == 0 ~ year - 4,
      year %% 4 == 1 ~ year - 1,
      year %% 4 == 2 ~ year - 2,
      year %% 4 == 3 ~ year - 3
    ),
    cd_muni_ibge = as.character(cd_muni_ibge),
    across(where(is.numeric), ~ ifelse(is.nan(.), NA, .)),

    # novas variáveis agregadas
    # y_cbo_medicos_saude_mental        = y_cbo_medico_diag_terap + y_cbo_psiquiatra,
    # y_cbo_primeiro_atend_saude_mental = y_cbo_ass_social + y_cbo_psico_clinico + y_cbo_psico_e_psicanalista + y_cbo_psiquiatra + y_cbo_terapeuta_ocupac,
    # y_cbo_medicos_saude_mental_ab     = y_cbo_medico_diag_terap_ab + y_cbo_psiquiatra_ab,
    # y_cbo_primeiro_atend_saude_mental_ab = y_cbo_ass_social_ab + y_cbo_psico_clinico_ab + y_cbo_psico_e_psicanalista_ab + y_cbo_psiquiatra_ab + y_cbo_terapeuta_ocupac_ab,
    # y_cbo_saude_mental    = y_cbo_medico_diag_terap + y_cbo_psiquiatra + y_cbo_ass_social + y_cbo_psico_clinico + y_cbo_psico_e_psicanalista + y_cbo_terapeuta_ocupac,
    # y_cbo_saude_mental_ab = y_cbo_medico_diag_terap_ab + y_cbo_psiquiatra_ab + y_cbo_ass_social_ab + y_cbo_psico_clinico_ab + y_cbo_psico_e_psicanalista_ab + y_cbo_terapeuta_ocupac_ab,
    y_psiquiatra_n_ab=y_cbo_psiquiatra-y_cbo_psiquiatra_ab) |> 
  group_by(cd_muni_ibge, mandato) |> 
  summarise(
    across(starts_with("y_"), ~ sum(., na.rm = TRUE)),
    .groups = "drop"
  ) |> 
  arrange(cd_muni_ibge, mandato) |> 
  group_by(cd_muni_ibge) |> 
  mutate(
    across(starts_with("y_"), ~ . - lag(.))
  ) |> 
  ungroup()



```


```{r}

df_rdd_cbo <- df_candidates |>
  filter(!ano %in% c('2004')) |> 
  #filter(ano==2020) |> 
  left_join(consolidado_cbo, by = c('ano' = 'mandato', 'cd_municipio_ibge_6' = 'cd_muni_ibge')) |> 
  
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ (./cov_municipio_pop_total)*100000,
    .names = "{.col}")) |> 
    
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))

```

```{r}
df_rdd_cbo <- df_candidates |>
  filter(!ano %in% c("2004")) |> 
  left_join(
    consolidado_cbo,
    by = c("ano" = "mandato", "cd_municipio_ibge_6" = "cd_muni_ibge")
  ) |> 

  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ (. / cov_municipio_pop_total) * 100000
  )) |> 

  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ replace_na(., 0)
  )) |> 

  arrange(cd_municipio_ibge_6, ano) |> 
  group_by(cd_municipio_ibge_6) |> 
  mutate(across(
    .cols = starts_with("y_"),
    .fns  = ~ lag(.),
    .names = "{.col}_previous"
  )) |>
  ungroup()

```


```{r}

y_vars <- names(df_rdd_cbo)[grepl("^y_", names(df_rdd_cbo))]

map(y_vars, ~ {RDD(df_rdd_cbo, x = val_margem_vitoria_feminina, y = !!sym(.x))})

#####rdd 2020
#map(y_vars, ~ {Rdd20(df_rdd_cbo, x = val_margem_vitoria_feminina, y = !!sym(.x))})

```

```{r}

RDD(df_rdd_cbo, x = val_margem_vitoria_feminina, y = y_cbo_psico_e_psicanalista)

rdplot(
  y = df_rdd_cbo$y_cbo_psico_e_psicanalista,
  x = df_rdd_cbo$val_margem_vitoria_feminina,
  kernel = "triangular",
  x.lim = c(-0.141, 0.141),
  y.lim = c(15, 30),
  nbins = 100,
  p = 1)

```

```{r}
rdplot(
  y = df_rdd_cbo$y_psiquiatra_n_ab,
  x = df_rdd_cbo$val_margem_vitoria_feminina,
  kernel = "triangular",
  x.lim = c(-0.141, 0.141),
  y.lim = c(-10, 10),
  nbins = 100,
  p = 1,
  x.label = "Margem de Vitória Feminina (%)",
  y.label = "Variação de Psiquiatras não atenção básica/100k hab"
)

```


## Teste de sensibilidade cbo

```{r}
y_vars <- names(df_rdd_cbo)[grepl("^y_", names(df_rdd_cbo))]

map(
  y_vars,
  ~ RDD_sensibilidade(
      df = df_rdd_cbo,
      x = val_margem_vitoria_feminina,
      y = !!sym(.x)
    )
)

```
