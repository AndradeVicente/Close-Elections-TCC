---
title: "adriano 2"
output: html_document
date: "2025-09-25"
---
##Bibliotecas
```{r}
library(tidyverse)
library(haven)
library(dplyr)
library(purrr)
```

## Bases raw
```{r}
df_adriano_raw <- read_dta('../../dados/Bases/Base_cosolidada_TCC_base3.dta')

df_adriano_raw |> view()
```

```{r}
df_candidates <- readRDS('../../dados/TSE_tratado_completo.RDS')
```

## Função RDD
```{r}
RDD <- function(df, x, y) {
  library(rdrobust)
  library(rlang)

  # pega o nome da variável y em formato string
  y_name <- as_label(enquo(y))

  df <- df |>
    filter(
      !is.na({{x}}),
      !is.na({{y}}),
      !is.na(ano),
      !is.na(cov_reeleicao),
      !is.na(cov_candidato_partido),
      !is.na(cov_candidato_educacao_agrupada),
      !is.na(cov_candidato_idade),
      !is.na(cov_municipio_proporcao_mulheres_pop),
      !is.na(cov_municipio_pop_total),
      !is.na(cd_municipio_ibge_7)
    )
  
    # se não tiver dados suficientes, pula
  if (nrow(df) < 30 || length(unique(df |> pull({{y}}))) < 5) {
    cat("\n====================\n")
    cat("Variável:", y_name, "- não tem dados suficientes. Pulando.\n")
    return(NULL)
  }


  controls <- model.matrix(
    ~ ano 
    + cov_reeleicao
    + cov_candidato_partido
    + cov_candidato_educacao_agrupada
    + cov_candidato_idade
    + cov_municipio_proporcao_mulheres_pop
    + cov_municipio_pop_total
    ,data = df)

  x_vals <- df |> pull({{x}})
  y_vals <- df |> pull({{y}})

  regressao <- rdrobust(
    x = x_vals,
    y = y_vals,
    covs = controls,
    cluster = df$cd_municipio_ibge_7,
    all = TRUE,
    kernel = "triangular"
  )

  cat("\n====================\n")
  cat("Resultado para variável:", y_name, "\n")
  print(summary(regressao))

  h <- regressao$bws[1]

  dados_filtrados <- tibble(x = x_vals, y = y_vals) |>
    filter(abs(x) <= h)

  ymax <- mean(dados_filtrados$y)

  rdplot(
    y = y_vals,
    x = x_vals,
    kernel = "triangular",
    x.lim = c(-h, h),
    y.lim = c(0, ymax * 2),
    nbins = 100,
    p = 4,
    title = paste("RDD Plot -", y_name),
    y.label = y_name,
    x.label = as_label(enquo(x))
  )
}
```


## Sinan
base sinan filtrando para casos de mulheres
```{r}

consolidado_sinan_fem <- df_adriano_raw |> 

  select(
    
    cd_muni = ibge,
    year,

    y_sinan_viol_fisica = VIOL_FISIC_fem,
    y_sinan_viol_financeira = VIOL_FINAN_fem,
    y_sinan_viol_psicologica = VIOL_PSICO_fem,
    y_sinan_viol_tortura = VIOL_TORT_fem,
    y_sinan_viol_sexual = VIOL_SEXU_fem,
    y_sinan_viol_trafico_humano = VIOL_TRAF_fem,
    y_sinan_viol_negligencia = VIOL_NEGLI_fem,
    y_sinan_viol_trabalho_infantil = VIOL_INFAN_fem,
    y_sinan_viol_intervencao_legal = VIOL_LEGAL_fem,
    y_sinan_viol_outros = VIOL_OUTR_fem,
    
    y_sinan_agressao_forca = AG_FORCA_fem,
    y_sinan_agressao_enforcamento = AG_ENFOR_fem,
    y_sinan_agressao_objeto_contudente = AG_OBJETO_fem,
    y_sinan_agressao_corte = AG_CORTE_fem,
    y_sinan_agressao_quente = AG_QUENTE_fem,
    y_sinan_agressao_evenenamento = AG_ENVEN_fem,
    y_sinan_agressao_fogo = AG_FOGO_fem,
    y_sinan_agressao_ameaca = AG_AMEACA_fem,
    y_sinan_agressao_outros = AG_OUTROS_fem,
    
    y_sinan_sex_assedio = SEX_ASSEDI_fem,
    y_sinan_sex_estupro = SEX_ESTUPR_fem,
    y_sinan_sex_pudor = SEX_PUDOR_fem,
    y_sinan_sex_pornografia_infantil = SEX_PORNO_fem,
    y_sinan_sex_exploracao_sexual = SEX_EXPLO_fem,
    y_sinan_sex_outro = SEX_OUTRO_fem) |> 
  
  mutate(
    mandato = case_when(year %% 4 == 0 ~ year - 4,
                        year %% 4 == 1 ~ year - 1,
                        year %% 4 == 2 ~ year - 2,
                        year %% 4 == 3 ~ year - 3),
    cd_muni = as.character(cd_muni)) |> 
  group_by(cd_muni, mandato) |> 
  
  summarise(across(
    .cols = starts_with("y_"),       
    .fns = ~ sum(.),  
    .names = "{.col}")) |> 
  
  mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))



```

base sinan geral 
```{r}

consolidado_sinan <- df_adriano_raw |> 

  select(
    
    cd_muni = ibge,
    year,
    
    #sinan mental
    y_sinan_mental_total_ocor_trab = total,
    y_sinan_mental_afast_trab = afastamento_trabalho,
    y_sinan_mental_afast_trab_desgaste = afastamento_situacao,
    y_sinan_mental_hab_psicofarmacos = habitos_psicofarmacos,
    y_sinan_mental_hab_fumar = habitos_fumar,
    y_sinan_mental_hab_drogas = habitos_drogas,
    y_sinan_mental_hab_alcool =habitos_alcool,
    y_sinan_mental_encaminhamento_caps = encaminhamento_caps,
    y_sinan_mental_cura = cura,
    y_sinan_mental_cura_n_conf = cura_nao_conf,
    y_sinan_mental_trabalho_obs_F = sexo_F,
    y_sinan_mental_trabalho_obs_M = sexo_M,
    y_sinan_mental_trabalho_obito = obito_trabalho,
    y_sinan_mental_incapacidade_temp = incapacidade_temp,
    y_sinan_mental_incapacidade_parc = incapacidade_perm_par,
    y_sinan_mental_incapacidade_total = incapacidade_perm_tot,
    
    #sinan violencia
    y_sinan_reincidencia   = OUT_VEZES_inter,
    y_sinan_autoprovocada = LES_AUTOP_inter,
    y_sinan_viol_fisica = VIOL_FISIC_inter,
    y_sinan_viol_financeira = VIOL_FINAN_inter,
    y_sinan_viol_psicologica = VIOL_PSICO_inter,
    y_sinan_viol_tortura = VIOL_TORT_inter,
    y_sinan_viol_sexual = VIOL_SEXU_inter,
    y_sinan_viol_trafico_humano = VIOL_TRAF_inter,
    y_sinan_viol_negligencia = VIOL_NEGLI_inter,
    y_sinan_viol_trabalho_infantil = VIOL_INFAN_inter,
    y_sinan_viol_intervencao_legal = VIOL_LEGAL_inter,
    y_sinan_viol_outros = VIOL_OUTR_inter,
    
    #sinan meio de agressao
    y_sinan_agressao_forca = AG_FORCA_inter,
    y_sinan_agressao_enforcamento = AG_ENFOR_inter,
    y_sinan_agressao_objeto_contudente = AG_OBJETO_inter,
    y_sinan_agressao_corte = AG_CORTE_inter,
    y_sinan_agressao_quente = AG_QUENTE_inter,
    y_sinan_agressao_evenenamento = AG_ENVEN_inter,
    y_sinan_agressao_fogo = AG_FOGO_inter,
    y_sinan_agressao_ameaca = AG_AMEACA_inter,
    y_sinan_agressao_outros = AG_OUTROS_inter,
    
    #sinan violencia sexual
    y_sinan_sex_assedio = SEX_ASSEDI_inter,
    y_sinan_sex_estupro = SEX_ESTUPR_inter,
    y_sinan_sex_pudor = SEX_PUDOR_inter,
    y_sinan_sex_pornografia_infantil = SEX_PORNO_inter,
    y_sinan_sex_exploracao_sexual = SEX_EXPLO_inter,
    y_sinan_sex_outro = SEX_OUTRO_inter,
    
    #sinan procedimento por tipo
    y_sinan_procedimento_aborto = PROC_ABORT_inter,
    y_sinan_procedimento_coleta_semen = PROC_SEMEN_inter,
    y_sinan_procedimento_coleta_vaginal = PROC_VAGIN_inter,
    y_sinan_procedimento_contracepcao_emerg = PROC_CONTR_inter,
    
    # ocorencias no momento da notificacao
    y_sinan_notificacao_dst = CONS_DST_inter,
    y_sinan_notificacao_suicidio = CONS_SUIC_inter,
    y_sinan_notificacao_mental = CONS_MENT_inter,
    y_sinan_notificacao_estresse_pos_tra = CONS_ESTRE_inter,
    
    #encaminhamento
    y_sinan_enc_rede_saude = ENC_SAUDE_inter,
    y_sinan_enc_abrigo = ENC_ABRIGO_inter,
    y_sinan_enc_sentinela = ENC_SENTIN_inter,
    y_sinan_enc_deam = ENC_DEAM_inter,
    y_sinan_enc_dpca = ENC_DPCA_inter,
    y_sinan_enc_delegacia_outra = ENC_DELEG_inter,
    y_sinan_enc_mp = ENC_MPU_inter,
    y_sinan_enc_mulher_abrigo = ENC_MULHER_inter,
    y_sinan_enc_creas = ENC_CREAS_inter,
    y_sinan_enc_iml = ENC_IML_inter) |> 
  
  mutate(
    mandato = case_when(year %% 4 == 0 ~ year - 4,
                        year %% 4 == 1 ~ year - 1,
                        year %% 4 == 2 ~ year - 2,
                        year %% 4 == 3 ~ year - 3),
    cd_muni = as.character(cd_muni)) |> 
  group_by(cd_muni, mandato) |> 
  
  summarise(across(
    .cols = starts_with("y_"),       
    .fns = ~ sum(.),  
    .names = "{.col}")) |> 
  
  mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))


```


```{r}

df_rdd_sinan <- df_candidates |>
  filter(!ano %in% c('2004')) |> 
  left_join(consolidado_sinan, by = c('ano' = 'mandato', 'cd_municipio_ibge_6' = 'cd_muni')) |> 
  
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ (./cov_municipio_pop_total)*100000,
    .names = "{.col}")) |> 
    
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))

```

RDD sinan
```{r}

y_vars <- names(df_rdd_sinan)[grepl("^y_", names(df_rdd_sinan))]

map(y_vars, ~ {RDD(df_rdd_sinan, x = val_margem_vitoria_feminina, y = !!sym(.x))})

```

```{r}

RDD(df_rdd_sinan, x = val_margem_vitoria_feminina, y = y_sinan_viol_psicologica)

rdplot(
  y = df_rdd_sinan$y_sinan_viol_psicologica,
  x = df_rdd_sinan$val_margem_vitoria_feminina,
  kernel = "triangular",
  x.lim = c(-0.141, 0.141),
  # y.lim = c(30, 100),
  nbins = 100,
  p = 4)

```

## SIA - Duda
descrição e label variáveis
```{r}

get_label <- function(x) {
  lb <- attr(x, "label", exact = TRUE)
  if (is.null(lb)) NA_character_ else as.character(lb)
}

proc_df <- df_adriano_raw %>% select(matches("^proc_\\d{2}$"))

descricoes <- tibble(
  variavel  = names(proc_df),
  descricao = map_chr(proc_df, get_label)
)

descricoes


```

ab: atenção básica; cap: centro de atenção psicossocial

```{r}

consolidado_sia <- df_adriano_raw |> 

  select(
    
    cd_muni = ibge,
    year,

    y_sia_serv_resid_terap = proc_01,
    y_sia_serv_resid_terap_transit = proc_02,
    y_sia_equipes_pessoa_prob_droga = proc_03,
    y_sia_pratica_corp_cap = proc_04,
    y_sia_matric_eq_ab = proc_05,
    y_sia_atend_indiv_cap = proc_06,
    y_sia_atend_gp_cap = proc_07,
    y_sia_atend_familia_cap = proc_08,
    y_sia_atend_inic_cap = proc_09,
    y_sia_atend_dom_pac_cap = proc_10,
    y_sia_abord_cog_fumante = proc_11,
    y_sia_acomp_pac_saude_mental = proc_12,
    y_sia_atend_oficina_terap1 = proc_13,
    y_sia_atend_oficina_terap2 = proc_14,
    y_sia_atend_psico_gp = proc_15,
    y_sia_atend_psico_indiv = proc_16,
    y_sia_acomp_adulto_sofre_drogas = proc_17,
    y_sia_acomp_jovem_sofre_drogas = proc_18,
    y_sia_acomp_neuropsi_paciente_reab = proc_20,
    y_sia_atend_urg_atencao_especializada = proc_21)|> 
  
  mutate(
    mandato = case_when(year %% 4 == 0 ~ year - 4,
                        year %% 4 == 1 ~ year - 1,
                        year %% 4 == 2 ~ year - 2,
                        year %% 4 == 3 ~ year - 3),
    cd_muni = as.character(cd_muni),
    y_sia_servi_resid_terap= y_sia_serv_resid_terap+y_sia_serv_resid_terap_transit,
    y_sia_atend_cap=y_sia_atend_indiv_cap+y_sia_atend_gp_cap+y_sia_atend_familia_cap+y_sia_atend_inic_cap+y_sia_atend_dom_pac_cap+y_sia_acomp_pac_saude_mental+y_sia_atend_psico_gp+y_sia_atend_psico_indiv,
    y_sia_atend_oficina= y_sia_atend_oficina_terap1+y_sia_atend_oficina_terap2,
    y_sia_acomp_drogas=y_sia_acomp_adulto_sofre_drogas+y_sia_acomp_jovem_sofre_drogas) |> 
  group_by(cd_muni, mandato) |> 
  
  summarise(across(
    .cols = starts_with("y_"),       
    .fns = ~ sum(.),  
    .names = "{.col}")) |> 
  
  mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))



```


```{r}

df_rdd_sia <- df_candidates |>
  filter(!ano %in% c('2004')) |> 
  left_join(consolidado, by = c('ano' = 'mandato', 'cd_municipio_ibge_6' = 'cd_muni')) |> 
  
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ (./cov_municipio_pop_total)*100000,
    .names = "{.col}")) |> 
    
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))

```

```{r}

y_vars <- names(df_rdd_sia)[grepl("^y_", names(df_rdd_sia))]

map(y_vars, ~ {RDD(df_rdd_sia, x = val_margem_vitoria_feminina, y = !!sym(.x))})


```

## SIH - Duda
descrição e label variáveis
```{r}


get_label <- function(x) {
  lb <- attr(x, "label", exact = TRUE)
  if (is.null(lb)) NA_character_ else as.character(lb)
}

# Seleciona todas as colunas que começam com F (maiúsculo)
f_df <- df_adriano_raw %>% 
  select(matches("^F"))

# Extrai nomes e labels
descricoes_F <- tibble(
  variavel  = names(f_df),
  descricao = map_chr(f_df, get_label)
)

descricoes_F

```

Curta: hospitalização de curta duração/ Longa; longa duração.
```{r}
consolidado_sih <- df_adriano_raw |> 
  select(
    cd_muni = ibge,
    year,
    ## homem
    y_sih_desordem_mental_curta_masc = F00_F09_curta_masc,
    y_sih_desordem_mental_por_drogas_curta_masc = F10_F19_curta_masc,
    y_sih_desordem_humor_curta_masc = F30_F39_curta_masc,
    y_sih_desordem_mental_por_estresse_curta_masc = F40_F49_curta_masc,
    y_sih_desordem_mental_esquizofrenia_curta_masc = F20_F29_curta_masc,
    y_sih_sindromes_comportamentais_curta_masc = F50_F59_curta_masc,
    y_sih_desordem_mental_personalidade_masc = F60_F69_curta_masc,
    y_sih_retardo_mental_curta_masc = F70_F79_curta_masc,
    y_sih_desordem_mental_infancia_adolesc_curta_masc = F90_F99_curta_masc,
    y_sih_desordem_mental_comportamento_curta_masc = F00_F99_curta_masc,
    y_sih_desordem_mental_long_masc = F00_F09_longa_masc,
    y_sih_desordem_mental_por_drogas_long_masc = F10_F19_longa_masc,
    y_sih_desordem_humor_long_masc = F30_F39_longa_masc,
    y_sih_desordem_mental_por_estresse_long_masc = F40_F49_longa_masc,
    y_sih_desordem_mental_esquizofrenia_long_masc = F20_F29_longa_masc,
    y_sih_sindromes_comportamentais_long_masc = F50_F59_longa_masc,
    y_sih_desordem_mental_personalidade_long_masc = F60_F69_longa_masc,
    y_sih_retardo_mental_long_masc = F70_F79_longa_masc,
    y_sih_desordem_mental_infancia_adolesc_long_masc = F90_F99_longa_masc,
    y_sih_desordem_mental_comportamento_long_masc = F00_F99_longa_masc,
    ## mulher
    y_sih_desordem_mental_curta_fem = F00_F09_curta_fem,
    y_sih_desordem_mental_por_drogas_curta_fem = F10_F19_curta_fem,
    y_sih_desordem_humor_curta_fem = F30_F39_curta_fem,
    y_sih_desordem_mental_por_estresse_curta_fem = F40_F49_curta_fem,
    y_sih_desordem_mental_esquizofrenia_curta_fem = F20_F29_curta_fem,
    y_sih_sindromes_comportamentais_curta_fem = F50_F59_curta_fem,
    y_sih_desordem_mental_personalidade_curta_fem = F60_F69_curta_fem,
    y_sih_retardo_mental_curta_fem = F70_F79_curta_fem,
    y_sih_desordem_mental_infancia_adolesc_curta_fem = F90_F99_curta_fem,
    y_sih_desordem_mental_comportamento_curta_fem = F00_F99_curta_fem,
    y_sih_desordem_mental_long_fem = F00_F09_longa_fem,
    y_sih_desordem_mental_por_drogas_long_fem = F10_F19_longa_fem,
    y_sih_desordem_humor_long_fem = F30_F39_longa_fem,
    y_sih_desordem_mental_por_estresse_long_fem = F40_F49_longa_fem,
    y_sih_desordem_mental_esquizofrenia_long_fem = F20_F29_longa_fem,
    y_sih_sindromes_comportamentais_long_fem = F50_F59_longa_fem,
    y_sih_desordem_mental_personalidade_long_fem = F60_F69_longa_fem,
    y_sih_retardo_mental_long_fem = F70_F79_longa_fem,
    y_sih_desordem_mental_infancia_adolesc_long_fem = F90_F99_longa_fem,
    y_sih_desordem_mental_comportamento_long_fem = F00_F99_longa_fem
  ) |> 
  mutate(
    mandato = case_when(
      year %% 4 == 0 ~ year - 4,
      year %% 4 == 1 ~ year - 1,
      year %% 4 == 2 ~ year - 2,
      year %% 4 == 3 ~ year - 3
    ),
    cd_muni = as.character(cd_muni),

    ## mulheres
    y_sih_hosp_desordem_mental_curta_fem =
      y_sih_desordem_mental_curta_fem +
      y_sih_desordem_mental_por_drogas_curta_fem +
      y_sih_desordem_humor_curta_fem +
      y_sih_desordem_mental_por_estresse_curta_fem +
      y_sih_desordem_mental_esquizofrenia_curta_fem +
      y_sih_sindromes_comportamentais_curta_fem +
      y_sih_desordem_mental_personalidade_curta_fem +
      y_sih_retardo_mental_curta_fem +
      y_sih_desordem_mental_infancia_adolesc_curta_fem +
      y_sih_desordem_mental_comportamento_curta_fem,

    y_sih_hosp_desordem_mental_longa_fem =
      y_sih_desordem_mental_long_fem +
      y_sih_desordem_mental_por_drogas_long_fem +
      y_sih_desordem_humor_long_fem +
      y_sih_desordem_mental_por_estresse_long_fem +
      y_sih_desordem_mental_esquizofrenia_long_fem +
      y_sih_sindromes_comportamentais_long_fem +
      y_sih_desordem_mental_personalidade_long_fem +
      y_sih_retardo_mental_long_fem +
      y_sih_desordem_mental_infancia_adolesc_long_fem +
      y_sih_desordem_mental_comportamento_long_fem,

    ## totais (homens + mulheres)
    y_sih_desordem_mental_curta = y_sih_desordem_mental_curta_masc + y_sih_desordem_mental_curta_fem,
    y_sih_desordem_mental_por_drogas_curta = y_sih_desordem_mental_por_drogas_curta_masc + y_sih_desordem_mental_por_drogas_curta_fem,
    y_sih_desordem_humor_curta = y_sih_desordem_humor_curta_masc + y_sih_desordem_humor_curta_fem,
    y_sih_desordem_mental_por_estresse_curta = y_sih_desordem_mental_por_estresse_curta_masc + y_sih_desordem_mental_por_estresse_curta_fem,
    y_sih_desordem_mental_esquizofrenia_curta = y_sih_desordem_mental_esquizofrenia_curta_masc + y_sih_desordem_mental_esquizofrenia_curta_fem,
    y_sih_sindromes_comportamentais_curta = y_sih_sindromes_comportamentais_curta_masc + y_sih_sindromes_comportamentais_curta_fem,
    y_sih_desordem_mental_personalidade_curta = y_sih_desordem_mental_personalidade_masc + y_sih_desordem_mental_personalidade_curta_fem,
    y_sih_retardo_mental_curta = y_sih_retardo_mental_curta_masc + y_sih_retardo_mental_curta_fem,
    y_sih_desordem_mental_infancia_adolesc_curta = y_sih_desordem_mental_infancia_adolesc_curta_masc + y_sih_desordem_mental_infancia_adolesc_curta_fem,
    y_sih_desordem_mental_comportamento_curta = y_sih_desordem_mental_comportamento_curta_masc + y_sih_desordem_mental_comportamento_curta_fem,

    y_sih_desordem_mental_long = y_sih_desordem_mental_long_masc + y_sih_desordem_mental_long_fem,
    y_sih_desordem_mental_por_drogas_long = y_sih_desordem_mental_por_drogas_long_masc + y_sih_desordem_mental_por_drogas_long_fem,
    y_sih_desordem_humor_long = y_sih_desordem_humor_long_masc + y_sih_desordem_humor_long_fem,
    y_sih_desordem_mental_por_estresse_long = y_sih_desordem_mental_por_estresse_long_masc + y_sih_desordem_mental_por_estresse_long_fem,
    y_sih_desordem_mental_esquizofrenia_long = y_sih_desordem_mental_esquizofrenia_long_masc + y_sih_desordem_mental_esquizofrenia_long_fem,
    y_sih_sindromes_comportamentais_long = y_sih_sindromes_comportamentais_long_masc + y_sih_sindromes_comportamentais_long_fem,
    y_sih_desordem_mental_personalidade_long = y_sih_desordem_mental_personalidade_long_masc + y_sih_desordem_mental_personalidade_long_fem,
    y_sih_retardo_mental_long = y_sih_retardo_mental_long_masc + y_sih_retardo_mental_long_fem,
    y_sih_desordem_mental_infancia_adolesc_long = y_sih_desordem_mental_infancia_adolesc_long_masc + y_sih_desordem_mental_infancia_adolesc_long_fem,
    y_sih_desordem_mental_comportamento_long = y_sih_desordem_mental_comportamento_long_masc + y_sih_desordem_mental_comportamento_long_fem,

    ## totais gerais
    y_sih_hosp_desordem_mental_curta = 
      y_sih_desordem_mental_curta + y_sih_desordem_mental_por_drogas_curta + y_sih_desordem_humor_curta +
      y_sih_desordem_mental_por_estresse_curta + y_sih_desordem_mental_esquizofrenia_curta + y_sih_sindromes_comportamentais_curta +
      y_sih_desordem_mental_personalidade_curta + y_sih_retardo_mental_curta +
      y_sih_desordem_mental_infancia_adolesc_curta + y_sih_desordem_mental_comportamento_curta,

    y_sih_hosp_desordem_mental_longa =
      y_sih_desordem_mental_long + y_sih_desordem_mental_por_drogas_long + y_sih_desordem_humor_long +
      y_sih_desordem_mental_por_estresse_long + y_sih_desordem_mental_esquizofrenia_long + y_sih_sindromes_comportamentais_long +
      y_sih_desordem_mental_personalidade_long + y_sih_retardo_mental_long +
      y_sih_desordem_mental_infancia_adolesc_long + y_sih_desordem_mental_comportamento_long
  ) |> 
  group_by(cd_muni, mandato) |> 
  summarise(across(starts_with("y_"), sum, na.rm = TRUE)) |> 
  mutate(across(starts_with("y_"), ~ replace_na(., 0)))


```


```{r}

df_rdd_sih <- df_candidates |>
  filter(!ano %in% c('2004')) |> 
  left_join(consolidado_sih, by = c('ano' = 'mandato', 'cd_municipio_ibge_6' = 'cd_muni')) |> 
  
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ (./cov_municipio_pop_total)*100000,
    .names = "{.col}")) |> 
    
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))

```

```{r}

y_vars <- names(df_rdd_sih)[grepl("^y_", names(df_rdd_sih))]

map(y_vars, ~ {RDD(df_rdd_sih, x = val_margem_vitoria_feminina, y = !!sym(.x))})


```

# CBO

verificar varíaveis e labels
```{r}

vars_cbo <- names(df_adriano_raw)[grepl("^cbo", names(df_adriano_raw), ignore.case = TRUE)]

tibble(
  variavel   = vars_cbo,
  descricao  = sapply(vars_cbo, function(v) attr(df_adriano_raw[[v]], "label"))
)


```


criar a base com variáveis CBO em variação (ab = atenção básica)
```{r}
consolidado_cbo <- df_adriano_raw |> 
  select(
    cd_muni_ibge = ibge,
    year,
    y_cbo_medico_diag_terap       = CBO_2253,
    y_cbo_ass_social              = CBO_2216_05,
    y_cbo_psico_clinico           = CBO_2215_10,
    y_cbo_psico_e_psicanalista    = CBO_2515,
    y_cbo_psiquiatra              = CBO_2251_33,
    y_cbo_terapeuta_ocupac        = CBO_2239_05,
    y_cbo_medico_diag_terap_ab    = CBO_2253_atbas,
    y_cbo_psico_clinico_ab        = CBO_2215_10_atbas,
    y_cbo_ass_social_ab           = CBO_2216_05_atbas,
    y_cbo_psico_e_psicanalista_ab = CBO_2515_atbas,
    y_cbo_psiquiatra_ab           = CBO_2251_33_atbas,
    y_cbo_terapeuta_ocupac_ab     = CBO_2239_05_atbas
  ) |> 
  mutate(
    mandato = case_when(
      year %% 4 == 0 ~ year - 4,
      year %% 4 == 1 ~ year - 1,
      year %% 4 == 2 ~ year - 2,
      year %% 4 == 3 ~ year - 3
    ),
    cd_muni_ibge = as.character(cd_muni_ibge),
    across(where(is.numeric), ~ ifelse(is.nan(.), NA, .)),

    # novas variáveis agregadas
    y_cbo_medicos_saude_mental        = y_cbo_medico_diag_terap + y_cbo_psiquiatra,
    y_cbo_primeiro_atend_saude_mental = y_cbo_ass_social + y_cbo_psico_clinico + y_cbo_psico_e_psicanalista + y_cbo_psiquiatra + y_cbo_terapeuta_ocupac,
    y_cbo_medicos_saude_mental_ab     = y_cbo_medico_diag_terap_ab + y_cbo_psiquiatra_ab,
    y_cbo_primeiro_atend_saude_mental_ab = y_cbo_ass_social_ab + y_cbo_psico_clinico_ab + y_cbo_psico_e_psicanalista_ab + y_cbo_psiquiatra_ab + y_cbo_terapeuta_ocupac_ab,
    y_cbo_saude_mental    = y_cbo_medico_diag_terap + y_cbo_psiquiatra + y_cbo_ass_social + y_cbo_psico_clinico + y_cbo_psico_e_psicanalista + y_cbo_terapeuta_ocupac,
    y_cbo_saude_mental_ab = y_cbo_medico_diag_terap_ab + y_cbo_psiquiatra_ab + y_cbo_ass_social_ab + y_cbo_psico_clinico_ab + y_cbo_psico_e_psicanalista_ab + y_cbo_terapeuta_ocupac_ab
  ) |> 
  group_by(cd_muni_ibge, mandato) |> 
  summarise(
    across(starts_with("y_"), ~ sum(., na.rm = TRUE)),
    .groups = "drop"
  ) |> 
  arrange(cd_muni_ibge, mandato) |> 
  group_by(cd_muni_ibge) |> 
  mutate(
    across(starts_with("y_"), ~ . - lag(.))
  ) |> 
  ungroup()



```


```{r}

df_rdd_cbo <- df_candidates |>
  filter(!ano %in% c('2004')) |> 
  left_join(consolidado_cbo, by = c('ano' = 'mandato', 'cd_municipio_ibge_6' = 'cd_muni_ibge')) |> 
  
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ (./cov_municipio_pop_total)*100000,
    .names = "{.col}")) |> 
    
    mutate(across(
    .cols = starts_with("y_"),
    .fns = ~ replace_na(., 0),
    .names = "{.col}"))

```

```{r}

y_vars <- names(df_rdd_cbo)[grepl("^y_", names(df_rdd_cbo))]

map(y_vars, ~ {RDD(df_rdd_cbo, x = val_margem_vitoria_feminina, y = !!sym(.x))})

```
