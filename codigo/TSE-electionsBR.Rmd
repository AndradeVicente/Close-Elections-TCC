---
title: "TSE-Margin-Victory"
author: "Vandrade"
date: "2024-06-10"
output: html_document
---

# Library and Setup

```{r warning=F}

library(tidyverse)
library(electionsBR)

year = c(2004, 2008, 2012, 2016, 2020)

```

# ElectionsBR 

## Electoral Zones Data
```{r}

fun_vote_mun_zone <- function(year) {
  elections_tse(year, type = 'vote_mun_zone', uf = 'all') |> 
    mutate(CD_MUNICIPIO = as.factor(CD_MUNICIPIO))
  
  }

df_candidates_votes <- map_df(year, fun_vote_mun_zone) |> 
  mutate(votos_zona = coalesce(QT_VOTOS_NOMINAIS_VALIDOS, QT_VOTOS_NOMINAIS)) |> 
  select(ano = ANO_ELEICAO,
         estado = SG_UF,
         cd_municipio_tse = CD_MUNICIPIO,
         nm_municipio = NM_MUNICIPIO,
         zona = NR_ZONA,
         cargo = DS_CARGO,
         nr_candidato = NR_CANDIDATO,
         nm_candidato = NM_CANDIDATO,
         votos_zona,
         partido = SG_PARTIDO) |> 
  filter(cargo == 'Prefeito') |> 
  group_by(ano, estado, cd_municipio_tse, nr_candidato) |> 
  summarize(nm_municipio = first(nm_municipio),
            nm_candidato = first(nm_candidato),
            total_votos = sum(votos_zona),
            partido = first(partido)) |> 
  group_by(ano, estado, cd_municipio_tse) |> 
  mutate(resultado = ifelse(total_votos == max(total_votos), 'Eleito', 'Não Eleito')) |> 
  mutate(cd_municipio_tse = as.factor(cd_municipio_tse)) |> 
  ungroup()
 
```

## Details about Electoral Zones (most importantly: Electoral Population)
```{r}

fun_details_mun_zone <- function(year) {
  elections_tse(year, type = 'details_mun_zone', uf = 'all') |> 
    mutate(CD_MUNICIPIO = as.factor(CD_MUNICIPIO))}

df_pop_votante <- map_df(year, fun_details_mun_zone) |> 
    select(ano = ANO_ELEICAO,
         estado = SG_UF,
         cd_municipio_tse = CD_MUNICIPIO,
         nm_municipio = NM_MUNICIPIO,
         zona = NR_ZONA,
         cargo = DS_CARGO,
         pop_votante = QT_APTOS,
         nr_abstencoes = QT_ABSTENCOES) |> 
  filter(cargo == 'Prefeito') |> 
  group_by(ano, estado, cd_municipio_tse) |> 
  summarize(nm_municipio = first(nm_municipio),
            pop_votante = sum(pop_votante)) |> 
  mutate(cd_municipio_tse = as.numeric(cd_municipio_tse)) |> 
  ungroup()

```

## Details about Candidates

```{r}

fun_details_mun_zone <- function(year) {
  df <- elections_tse(year, type = 'candidate', uf = 'all')
  if (year != 2020) {
    df$NR_PROTOCOLO_CANDIDATURA <- as.character(df$NR_PROTOCOLO_CANDIDATURA)
  }
  df$NR_CPF_CANDIDATO <- as.character(df$NR_CPF_CANDIDATO)
  df$CD_COR_RACA <- as.character(df$CD_COR_RACA)

  return(df)
}


df_candidates_details <- map_df(year, fun_details_mun_zone) |> 
  select(ano = ANO_ELEICAO, #selecionando e filtrando as variaveis
         estado = SG_UF,
         cd_municipio_tse = SG_UE,
         nm_municipio_tse = NM_UE,
         cargo = DS_CARGO,
         nr_candidato = NR_CANDIDATO,
         nm_candidato = NM_CANDIDATO,
         partido = SG_PARTIDO,
         idade = NR_IDADE_DATA_POSSE,
         genero = DS_GENERO,
         educacao = DS_GRAU_INSTRUCAO,
         cor_raca = DS_COR_RACA,
         ocupacao = DS_OCUPACAO,
         cd_seq_candidato =SQ_CANDIDATO) |> 
  filter(cargo == 'PREFEITO') |> 
  group_by(ano, estado, cd_municipio_tse, nr_candidato, cd_seq_candidato) |> # some of the candidates are repeated. 
  summarise(idade = max(idade),
            nm_partido = first(partido), 
            nm_candidato = first(nm_candidato),
            nm_genero = first(genero),
            nm_educacao = first(educacao),
            nm_cor_raca = first(cor_raca),
            nm_ocupacao = first(ocupacao),
            nm_municipio_tse = first(nm_municipio_tse),
            cd_seq_candidato = first(cd_seq_candidato)) |> 
  ungroup()

 

```

## Value of Assets

```{r}
year = c(2008, 2012, 2016, 2020)


fun_values_of_assets <- function(year) {
  df <- elections_tse(year, type = 'personal_finances', uf = 'all')

  if ("HH_ULTIMA_ATUALIZACAO" %in% names(df)) {
    df <- df |> mutate(HH_ULTIMA_ATUALIZACAO = as.character(HH_ULTIMA_ATUALIZACAO))
  }

}

df_values_of_assets <- map_df(year, fun_values_of_assets) |> 
  select(ano = ANO_ELEICAO,
         cd_municipio_tse = SG_UE,
         cd_seq_candidato = SQ_CANDIDATO,
         nm_desc_bem = DS_BEM_CANDIDATO,
         val_patrimonio_candidato = VR_BEM_CANDIDATO)


```

# Joining databases 
```{r}
df_candidates_votes |> head(1)
```

```{r}

df_candidates_votes |> 
  left_join(df_candidates_details, by = c('ano', 'cd_municipio_tse', 'nr_candidato'))  
  
left_join(df_values_of_assets) |> 
  left_join(df_pop_votante)

df_candidates_details |> head(1)
```




# Aditional Information

```{r}

cd_ibge <- read_csv("Dados/municipios_brasileiros_tse.csv") |> 
  select(codigo_tse, codigo_ibge) |>           
  mutate(codigo_ibge_sus = as.character(codigo_ibge),
         codigo_ibge_sus = substring(codigo_ibge_sus, 1, 6),
         codigo_ibge_sus = as.numeric(codigo_ibge_sus))

muni_geomentry <- read_municipality(code_muni = 'all') |> 
  select(code_muni, geom)

pop_censo <- read_xlsx("Dados/pop-sexo-censo-2010.xlsx") |> 
  rename(cd_muni = Município,
         pop_mas = Masculino, 
         pop_fem = Feminino) |> 
  mutate(cd_muni = substr(cd_muni,1, 6),
         cd_muni = as.numeric(cd_muni),
         pop_total = pop_mas + pop_fem,
         prop_fem_pop = pop_fem/pop_total)

```


# CANDIDATES dataframe

```{r}

candidates <- df_candidates_votes |> 
  left_join(df_candidates_details, by = c('ano', 'estado', 'nr_candidato', 'nm_candidato', 'partido')) |> 
  left_join(cd_ibge, by= c('cd_municipio_tse' = 'codigo_tse')) |> 
  left_join(muni_geomentry, by=c('codigo_ibge' = 'code_muni')) |> 
  left_join(df_pop_votante, by= c('ano', 'estado', 'cd_municipio_tse', 'nm_municipio')) |>
  left_join(pop_censo, by = c('codigo_ibge_sus' = 'cd_muni')) |> 
  mutate(genero = ifelse(genero %in% c("NÃO INFORMADO", "NÃO DIVULGÁVEL"), NA, genero))

```

## creating RDS file 
```{r}

saveRDS(candidates, file = "Dados/candidates.rds")

```













